\section{Performance testing}

Advanced utility types do have a significant strain on type checking and can have a negative impact on the developer experience with worse latency of language services and longer build times when building with \code{tsc}. The performance test suite has been created to measure the impact of various implemented math operations on type-checking performance.

Two metrics are measured in the performance test suite: the \say{check time} obtained from extended diagnostics when compiling via \code{tsc} and the number of type instantiations performed when evaluating utility types. These metrics can be obtained from the \code{tsc} \acrshort{cli} with the \code{--extendedDiagnostics} flag, but parsing the compiler output can be unnecessarily error-prone. Instead, the TypeScript API does expose an internal \code{performance} singleton, which, combined with internal \code{extendedDiagnostics} flag and Compiler \acrshort{api}, can be used to obtain the same metrics programmatically, as seen in Listing \ref{lst:performance-metrics}.

\begin{listing}[ht]
  \caption{Programmatic access to internal extended performance metrics}\label{lst:performance-metrics}
  \begin{minted}{TypeScript}
import * as ts from "typescript"
const performance = (ts as any).performance

performance.enable()
const program = ts.createProgram(fileNames, {
  noEmit: true,
  incremental: false,
  extendedDiagnostics: true,
})
program.emit()

console.log(`Instantiation count: ${program.getInstantiationCount()}`)
console.log(`Check time: ${performance.getDuration("Check")}`)
performance.disable()
\end{minted}
\end{listing}


\begin{tabular}{lll}
  \toprule
  {}                                     & Instantiation Count & Check Time               \\
  \midrule
  \code{Add<"1", "1">}                   & 50389               & $626.1480 \pm 2732.4835$ \\
  \code{Add<"1", "10">}                  & 50541               & $608.1964 \pm 1490.2754$ \\
  \code{Add<"1", "100">}                 & 50637               & $628.2837 \pm 1187.9201$ \\
  \code{Add<"1", "1000">}                & 50734               & $590.4544 \pm 1323.4114$ \\
  \code{Add<"1", "10000">}               & 50833               & $563.4551 \pm 503.1991$  \\
  \code{Add<"1", "100000">}              & 50934               & $564.6383 \pm 326.1892$  \\
  \code{Add<"1", "1000000">}             & 51037               & $590.2288 \pm 800.6683$  \\
  \code{Add<"1", "10000000">}            & 51142               & $566.8994 \pm 1322.4848$ \\
  \code{Add<"1", "100000000">}           & 51249               & $592.8983 \pm 2703.7284$ \\
  \code{Add<"1", "1000000000">}          & 51358               & $580.8956 \pm 732.7624$  \\
  \code{Add<"1", "10000000000">}         & 51469               & $602.9816 \pm 2772.3885$ \\
  \code{Add<"1", "100000000000">}        & 51582               & $574.9316 \pm 443.2602$  \\
  \code{Add<"1", "1000000000000">}       & 51714               & $573.1765 \pm 288.5311$  \\
  \code{Add<"1", "10000000000000">}      & 51849               & $593.7831 \pm 815.4532$  \\
  \code{Add<"1", "100000000000000">}     & 51987               & $576.2892 \pm 1581.0826$ \\
  \code{Add<"1", "1000000000000000">}    & 52128               & $564.1985 \pm 226.5942$  \\
  \code{Add<"1", "10000000000000000">}   & 52272               & $561.8088 \pm 202.4868$  \\
  \code{Add<"1", "100000000000000000">}  & 52419               & $588.9620 \pm 1605.4446$ \\
  \code{Add<"1", "1000000000000000000">} & 52569               & $598.1670 \pm 2184.9193$ \\
  \bottomrule
\end{tabular}


\begin{tabular}{lll}
  \toprule
  {}                                          & Instantiation Count & Check Time               \\
  \midrule
  \code{Multiply<"1", "1">}                   & 52418               & $566.2856 \pm 1304.8233$ \\
  \code{Multiply<"1", "10">}                  & 52742               & $586.9069 \pm 2054.9946$ \\
  \code{Multiply<"1", "100">}                 & 53057               & $548.8409 \pm 291.8180$  \\
  \code{Multiply<"1", "1000">}                & 53436               & $552.7645 \pm 1010.9699$ \\
  \code{Multiply<"1", "10000">}               & 53879               & $573.1269 \pm 1982.9075$ \\
  \code{Multiply<"1", "100000">}              & 54383               & $552.6068 \pm 404.8264$  \\
  \code{Multiply<"1", "1000000">}             & 54948               & $543.9872 \pm 156.1134$  \\
  \code{Multiply<"1", "10000000">}            & 55574               & $552.3896 \pm 391.9594$  \\
  \code{Multiply<"1", "100000000">}           & 56261               & $569.8469 \pm 1450.4120$ \\
  \code{Multiply<"1", "1000000000">}          & 57009               & $582.6160 \pm 2282.8004$ \\
  \code{Multiply<"1", "10000000000">}         & 57818               & $588.8492 \pm 2708.3371$ \\
  \code{Multiply<"1", "100000000000">}        & 58705               & $571.0721 \pm 1108.1628$ \\
  \code{Multiply<"1", "1000000000000">}       & 59654               & $561.9530 \pm 502.5156$  \\
  \code{Multiply<"1", "10000000000000">}      & 60665               & $586.2230 \pm 1929.5835$ \\
  \code{Multiply<"1", "100000000000000">}     & 61738               & $582.3424 \pm 1791.3684$ \\
  \code{Multiply<"1", "1000000000000000">}    & 62873               & $594.4613 \pm 2638.3184$ \\
  \code{Multiply<"1", "10000000000000000">}   & 64070               & $586.1715 \pm 1270.7923$ \\
  \code{Multiply<"1", "100000000000000000">}  & 65329               & $580.8701 \pm 641.9969$  \\
  \code{Multiply<"1", "1000000000000000000">} & 66650               & $587.0313 \pm 1519.6371$ \\
  \bottomrule
\end{tabular}

\begin{tabular}{lll}
  \toprule
  {}                                        & Instantiation Count & Check Time               \\
  \midrule
  \code{Divide<"1", "3">}                   & 56065               & $611.1183 \pm 3712.1221$ \\
  \code{Divide<"10", "3">}                  & 56007               & $566.6266 \pm 1312.9779$ \\
  \code{Divide<"100", "3">}                 & 56190               & $554.2810 \pm 178.3204$  \\
  \code{Divide<"1000", "3">}                & 56257               & $545.5406 \pm 1368.3422$ \\
  \code{Divide<"10000", "3">}               & 56317               & $552.3237 \pm 1120.0729$ \\
  \code{Divide<"100000", "3">}              & 56377               & $579.1138 \pm 841.8474$  \\
  \code{Divide<"1000000", "3">}             & 56437               & $590.3914 \pm 2730.2088$ \\
  \code{Divide<"10000000", "3">}            & 56497               & $552.0362 \pm 983.1479$  \\
  \code{Divide<"100000000", "3">}           & 56557               & $552.2182 \pm 1549.2122$ \\
  \code{Divide<"1000000000", "3">}          & 56617               & $576.9744 \pm 1538.6618$ \\
  \code{Divide<"10000000000", "3">}         & 56677               & $584.4138 \pm 1771.3998$ \\
  \code{Divide<"100000000000", "3">}        & 56767               & $575.2797 \pm 2817.7110$ \\
  \code{Divide<"1000000000000", "3">}       & 56875               & $574.0339 \pm 1187.0906$ \\
  \code{Divide<"10000000000000", "3">}      & 56985               & $572.9396 \pm 1845.7412$ \\
  \code{Divide<"100000000000000", "3">}     & 57097               & $544.0291 \pm 187.0663$  \\
  \code{Divide<"1000000000000000", "3">}    & 57211               & $610.6468 \pm 1628.6978$ \\
  \code{Divide<"10000000000000000", "3">}   & 57327               & $597.4917 \pm 751.0289$  \\
  \code{Divide<"100000000000000000", "3">}  & 57445               & $549.7234 \pm 404.5449$  \\
  \code{Divide<"1000000000000000000", "3">} & 57565               & $580.1838 \pm 1396.0654$ \\
  \bottomrule
\end{tabular}


\begin{tabular}{lll}
  \toprule
  {}                                      & Instantiation Count & Check Time                  \\
  \midrule
  \code{Root<"1", "2">}                   & 101781              & $657.9258 \pm 4637.2670$    \\
  \code{Root<"10", "2">}                  & 943579              & $2231.2624 \pm 26354.7449$  \\
  \code{Root<"100", "2">}                 & 995709              & $2358.4428 \pm 46642.8882$  \\
  \code{Root<"1000", "2">}                & 1150338             & $2457.2318 \pm 7974.3022$   \\
  \code{Root<"10000", "2">}               & 1290084             & $2717.1363 \pm 22569.9561$  \\
  \code{Root<"100000", "2">}              & 1390432             & $3114.9099 \pm 89929.3402$  \\
  \code{Root<"1000000", "2">}             & 1480678             & $3476.8778 \pm 132963.1171$ \\
  \code{Root<"10000000", "2">}            & 1715701             & $3535.6702 \pm 217462.3269$ \\
  \code{Root<"100000000", "2">}           & 1944285             & $4017.5913 \pm 22143.6082$  \\
  \code{Root<"1000000000", "2">}          & 2264897             & $4512.2763 \pm 45757.7304$  \\
  \code{Root<"10000000000", "2">}         & 2614395             & $5477.2640 \pm 64109.5688$  \\
  \code{Root<"100000000000", "2">}        & 2898459             & $6333.6284 \pm 9891.4644$   \\
  \code{Root<"1000000000000", "2">}       & 3157392             & $6439.0302 \pm 36044.4666$  \\
  \code{Root<"10000000000000", "2">}      & 3400798             & $6758.4044 \pm 84619.0587$  \\
  \code{Root<"100000000000000", "2">}     & 3630962             & $6763.4433 \pm 32105.0016$  \\
  \code{Root<"1000000000000000", "2">}    & 3861157             & $7483.2405 \pm 52541.9327$  \\
  \code{Root<"10000000000000000", "2">}   & 4087750             & $7638.8097 \pm 163773.6981$ \\
  \code{Root<"100000000000000000", "2">}  & 4319968             & $8199.8814 \pm 306798.3177$ \\
  \code{Root<"1000000000000000000", "2">} & 4558096             & $8563.6442 \pm 363040.7800$ \\
  \bottomrule
\end{tabular}

\begin{itemize}
  \item Difference between operations, execution time + number of created types \code{yarn tsc --noEmit --incremental false --generateTrace trace --extendedDiagnostics --listFiles -p tsconfig.json --explainFiles}
  \item Comparison between other libraries (arielhs/ts-arithmetic)
\end{itemize}
